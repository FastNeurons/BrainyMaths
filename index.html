<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Math Tricks — Rapid Practice</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body,#root{height:100%}
    body{background:linear-gradient(180deg,#0f172a,#020617);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
  </style>
</head>
<body>
  <div id="root" class="min-h-screen flex items-center justify-center p-6"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
  const { useState, useEffect, useRef } = React;

  function App(){
    const [running,setRunning] = useState(false);
    const [finished,setFinished] = useState(false);
    const [timeLeft,setTimeLeft] = useState(60);
    const [question,setQuestion] = useState(null);
    const [input,setInput] = useState('');
    const [score,setScore] = useState(0);
    const [attempts,setAttempts] = useState(0);
    const [sessionQuestions,setSessionQuestions] = useState([]);
    const [history,setHistory] = useState(()=>{try{return JSON.parse(localStorage.getItem('mt_history_v2'))||[]}catch(e){return []}});
    const [opsStats,setOpsStats] = useState(()=>{try{return JSON.parse(localStorage.getItem('mt_ops_v2'))||{}}catch(e){return {}}});
    const [currentMode,setCurrentMode] = useState(null);
    const [allQuestions,setAllQuestions] = useState([]);
    const [startTime,setStartTime] = useState(null);

    const timerRef = useRef(null);

    useEffect(()=>{localStorage.setItem('mt_history_v2',JSON.stringify(history))},[history]);
    useEffect(()=>{localStorage.setItem('mt_ops_v2',JSON.stringify(opsStats))},[opsStats]);

    useEffect(()=>{
      function handleKey(e){
        if(!running) return;
        if(e.key>='0' && e.key<='9'){ appendDigit(e.key) }
        else if(e.key==='Backspace'){ backspace() }
        else if(e.key==='Enter'){ handleSubmit() }
        else if(e.key==='c' || e.key==='C'){ clearInput() }
      }
      window.addEventListener('keydown',handleKey);
      return ()=> window.removeEventListener('keydown',handleKey);
    },[running,question,input]);

    useEffect(()=>{
      if(running && currentMode==='timed60' && timeLeft>0){
        timerRef.current = setTimeout(()=> setTimeLeft(t=>t-1),1000);
      } else if(currentMode==='timed60' && timeLeft===0 && running){
        endGame();
      }
      return ()=> clearTimeout(timerRef.current);
    },[running,timeLeft,currentMode]);

    const defaultOps = ['addition','subtraction','multiplication','division','percentage','squares','sqroot'];
    const difficultyParams = {
      easy: { maxAdd:50, maxMul:12, sqMax:20, responseThreshold:6 },
      medium: { maxAdd:99, maxMul:30, sqMax:50, responseThreshold:4 },
      hard: { maxAdd:999, maxMul:99, sqMax:125, responseThreshold:2.5 }
    };

    function pickOperation(){
      const weights = defaultOps.map(op=>{
        const stat = opsStats[op]; if(!stat||stat.attempts<3) return 1.0; const acc = stat.correct/stat.attempts; return 1.2-acc;
      });
      const sum = weights.reduce((a,b)=>a+b,0); const r = Math.random()*sum; let s=0; for(let i=0;i<defaultOps.length;i++){s+=weights[i]; if(r<=s) return defaultOps[i]} return defaultOps[0];
    }

    function generateQuestion(mode){
      if(mode==='timed60'){
        const op = pickOperation();
        const params = difficultyParams['medium'];
        switch(op){
          case 'addition':{
            const a = Math.floor(Math.random()*(params.maxAdd-10))+10; 
            const b = Math.floor(Math.random()*(params.maxAdd-5))+5;
            return {op,text:`${a} + ${b}`,answer:a+b,meta:{a,b,trick:'Make round then add remainder'}};
          }
          case 'subtraction':{
            const a = Math.floor(Math.random()*(params.maxAdd-5))+10; 
            const b = Math.floor(Math.random()*(Math.max(5,a-5)))+1;
            return {op,text:`${a} - ${b}`,answer:a-b,meta:{a,b,trick:'Use complements or borrow'}};
          }
          case 'multiplication':{
            const style=Math.random();
            if(style<0.35){ const a=Math.floor(Math.random()*params.maxMul)+11; return {op,text:`${a} × 11`,answer:a*11,meta:{a,trick:'×11 trick'}}} 
            else if(style<0.7){ const tens=Math.floor(Math.random()*8)+2; const u=Math.floor(Math.random()*9)+1; const a=tens*10+u; const b=(10-tens)*10+u; return {op,text:`${a} × ${b}`,answer:a*b,meta:{a,b,trick:'Vedic pattern'}}} 
            else { const a=Math.floor(Math.random()*params.maxMul)+2; const b=Math.floor(Math.random()*params.maxMul)+2; return {op,text:`${a} × ${b}`,answer:a*b,meta:{a,b,trick:'Split friendly'}}}
          }
          case 'division':{
            const divisor=Math.floor(Math.random()*20)+2; const quotient=Math.floor(Math.random()*10)+2; const dividend=divisor*quotient;
            return {op,text:`${dividend} ÷ ${divisor}`,answer:quotient,meta:{dividend,divisor,trick:'Factor dividend'}};
          }
          case 'percentage':{
            const bases=[25,40,50,75,10,20,200,125,80]; let base=bases[Math.floor(Math.random()*bases.length)];
            const percArr=[5,10,12,15,20,25,30,40,50]; let percent=percArr[Math.floor(Math.random()*percArr.length)];
            while((percent*base)%100!==0) percent=percArr[Math.floor(Math.random()*percArr.length)];
            const answer=(percent*base)/100;
            return {op,text:`${percent}% of ${base}`,answer,meta:{base,percent,trick:'Decompose using 10%/5%'}};
          }
          case 'squares':{
            const n=Math.floor(Math.random()*125)+1; return {op,text:`${n}²`,answer:n*n,meta:{n,trick:'Use (a±b)^2'}};
          }
          case 'sqroot':{
            const roots=[]; for(let i=1;i<=25;i++) roots.push(i*i); const val=roots[Math.floor(Math.random()*roots.length)]; return {op,text:`√${val}`,answer:Math.sqrt(val),meta:{val,trick:'Memorize small squares'}};
          }
        }
      }
    }

    function shuffleArray(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];} return arr;}

    function startMode(mode){
      setCurrentMode(mode);
      setScore(0); setAttempts(0); setSessionQuestions([]);
      setFinished(false); setRunning(true); setTimeLeft(mode==='timed60'?60:0);

      let preGen = [];
      if(mode==='squares126'){ for(let i=1;i<=125;i++) preGen.push(i*i); shuffleArray(preGen); }
      else if(mode==='percentages'){
        const bases=[25,40,50,75,10,20,200,125,80]; const percArr=[5,10,12,15,20,25,30,40,50];
        for(let i=0;i<30;i++){
          let base=bases[Math.floor(Math.random()*bases.length)];
          let percent=percArr[Math.floor(Math.random()*percArr.length)];
          while((percent*base)%100!==0) percent=percArr[Math.floor(Math.random()*percArr.length)];
          preGen.push({base,percent});
        }
      } else if(mode==='powers'){
        const powMap={'2':12,'3':6,'4':4,'5':4,'6':4,'7':4,'8':4,'9':4}; const nums=Object.keys(powMap);
        for(let i=0;i<30;i++){
          const base=nums[Math.floor(Math.random()*nums.length)];
          const maxPow=powMap[base];
          const exp=Math.floor(Math.random()*maxPow)+1;
          preGen.push({base,exp});
        }
      } else if(mode==='cubes'){ for(let i=1;i<=15;i++) preGen.push(i); shuffleArray(preGen);}
      else if(mode==='tables'){ for(let i=0;i<30;i++){ const n=Math.floor(Math.random()*30)+1; const t=Math.floor(Math.random()*30)+1; preGen.push({n,t});} }

      setAllQuestions(preGen);
      setStartTime(Date.now());
      nextQuestion(mode, preGen);
    }

    function nextQuestion(mode, arr=allQuestions){
      if(mode!=='timed60' && arr.length===0){ endGame(); return; }

      let q;
      if(mode==='squares126'){ const val=arr.shift(); setAllQuestions([...arr]); q={op:'squares',text:`${Math.sqrt(val)}²`,answer:val,meta:{n:Math.sqrt(val),trick:'Memorize anchors'}}; }
      else if(mode==='percentages'){ const item=arr.shift(); setAllQuestions([...arr]); q={op:'percentage',text:`${item.percent}% of ${item.base}`,answer:(item.percent*item.base)/100,meta:{base:item.base,percent:item.percent,trick:'Use tricks for integer answers'}}; }
      else if(mode==='powers'){ const item=arr.shift(); setAllQuestions([...arr]); q={op:'powers',text:`${item.base}^${item.exp}`,answer:Math.pow(parseInt(item.base),item.exp),meta:{base:item.base,exp:item.exp,trick:'Use power rules'}}; }
      else if(mode==='cubes'){ const n=arr.shift(); setAllQuestions([...arr]); q={op:'cubes',text:`${n}³`,answer:n*n*n,meta:{n,trick:'Memorize cube values'}}; }
      else if(mode==='tables'){ const item=arr.shift(); setAllQuestions([...arr]); q={op:'tables',text:`${item.n} × ${item.t}`,answer:item.n*item.t,meta:{n:item.n,t:item.t,trick:'Recall multiplication tables'}}; }
      else { q = generateQuestion('timed60'); }

      setQuestion(q); setInput('');
    }

    function handleSubmit(){
      if(!question) return; 
      const userAns = parseInt(input,10); 
      const correct = userAns===question.answer; 
      setAttempts(a=>a+1);
      setSessionQuestions(s=>[...s,{...question,input,correct,timestamp:Date.now()}]);
      setOpsStats(prev=>{
        const op=question.op; 
        const cur=prev[op]||{attempts:0,correct:0}; 
        return {...prev,[op]:{attempts:cur.attempts+1, correct:cur.correct+(correct?1:0)}}
      });
      if(correct) setScore(s=>s+1);
      nextQuestion(currentMode);
    }

    function appendDigit(d){ if(input.length>=6) return; setInput(s=> (s==='0'?String(d): s + d)) }
    function backspace(){ setInput(s=>s.slice(0,-1)) }
    function clearInput(){ setInput('') }
    function exitGame(){setRunning(false); setFinished(false); setCurrentMode(null); setInput('');}

    function endGame(){
      setRunning(false); setFinished(true);
      const duration = currentMode==='timed60'?60:Math.round((Date.now()-startTime)/1000);
      const session = { date:new Date().toISOString(), score, attempts, duration, questions: sessionQuestions };
      setHistory(h=>[session,...h].slice(0,200));
    }

    function solutionFor(q){
      const m=q.meta||{};
      switch(q.op){
        case 'addition': return `${m.a}+${m.b}=${q.answer}. Trick: ${m.trick}`;
        case 'subtraction': return `${m.a}-${m.b}=${q.answer}. Trick: ${m.trick}`;
        case 'multiplication': return `${m.a||''}×${m.b||11}=${q.answer}. Trick: ${m.trick||''}`;
        case 'division': return `${m.dividend}÷${m.divisor}=${q.answer}. Trick: ${m.trick}`;
        case 'percentage': return `${m.percent}% of ${m.base}=${q.answer}. Trick: ${m.trick}`;
        case 'squares': return `${m.n}²=${q.answer}. Trick: ${m.trick}`;
        case 'sqroot': return `√${m.val}=${q.answer}. Trick: ${m.trick}`;
        case 'powers': return `${m.base}^${m.exp}=${q.answer}. Trick: ${m.trick}`;
        case 'cubes': return `${m.n}³=${q.answer}. Trick: ${m.trick}`;
        case 'tables': return `${m.n}×${m.t}=${q.answer}. Trick: ${m.trick}`;
      }
    }

    const weakest = ()=>{
      const keys=Object.keys(opsStats); if(keys.length===0) return '—'; 
      let worst=null; let worstAcc=1.1; 
      keys.forEach(k=>{
        const {attempts=0,correct=0}=opsStats[k]||{}; 
        if(attempts>=3){
          const acc=correct/attempts; 
          if(acc<worstAcc){worstAcc=acc; worst=k}
        }
      }); 
      return worst||'—';
    }

    return (
      <div className="max-w-4xl w-full text-white">
        <header className="flex items-center justify-between mb-6">
          <h1 className="text-3xl font-bold">Math Tricks — Rapid Practice</h1>
          <div className="flex gap-3 items-center">
            <div className="text-lg text-gray-300">Weakest: <span className="font-semibold text-white">{weakest()}</span></div>
            <button onClick={()=>{setHistory([]); setOpsStats({}); localStorage.removeItem('mt_history_v2'); localStorage.removeItem('mt_ops_v2');}} className="text-sm px-3 py-1 rounded-lg bg-slate-700/40">Reset</button>
          </div>
        </header>

        {!running && !finished && (
          <main className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <section className="bg-slate-800/30 p-6 rounded-2xl">
              <div className="text-xl font-semibold mb-4">Select Mode:</div>
              <div className="grid grid-cols-2 gap-3">
                <button onClick={()=>startMode('timed60')} className="px-4 py-2 rounded-xl bg-indigo-600">60s Dynamic ⏱️</button>
                <button onClick={()=>startMode('squares126')} className="px-4 py-2 rounded-xl bg-emerald-600">Squares 1–125 🔢</button>
                <button onClick={()=>startMode('percentages')} className="px-4 py-2 rounded-xl bg-orange-500">Percentages 📊</button>
                <button onClick={()=>startMode('powers')} className="px-4 py-2 rounded-xl bg-purple-600">Powers 2–9 ✨</button>
                <button onClick={()=>startMode('cubes')} className="px-4 py-2 rounded-xl bg-pink-500">Cubes 1–15 🔺</button>
                <button onClick={()=>startMode('tables')} className="px-4 py-2 rounded-xl bg-teal-500">Tables ×30 🧮</button>
              </div>
            </section>
            <aside className="bg-slate-800/20 p-4 rounded-2xl">
              <div className="grid gap-3">
                <div>
                  <div className="text-sm text-gray-300">Best score</div>
                  <div className="text-lg font-semibold">{history.length? Math.max(...history.map(h=>h.score)) : 0}</div>
                </div>
                <div>
                  <div className="text-sm text-gray-300">Games played</div>
                  <div className="text-lg font-semibold">{history.length}</div>
                </div>
                <div>
                  <div className="text-sm text-gray-300">Weak area</div>
                  <div className="text-lg font-semibold">{weakest()}</div>
                </div>
              </div>
            </aside>
          </main>
        )}

        {running && question && (
          <main className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <section className="md:col-span-2 bg-slate-800/30 p-4 rounded-2xl">
              <div className="flex justify-between mb-3">
                {currentMode==='timed60' && (
                  <div>
                    <div className="text-sm text-gray-300">Time Left</div>
                    <div className="text-3xl font-bold">{String(timeLeft).padStart(2,'0')}s</div>
                  </div>
                )}
                <div className="text-right">
                  <div className="text-sm text-gray-300">Score</div>
                  <div className="text-2xl font-semibold">{score} / {attempts}</div>
                </div>
              </div>

              <div className="bg-white/5 rounded-2xl p-6 mb-4">
                <div className="text-2xl font-semibold">{question.text}</div>

                <div className="mt-6 bg-slate-900/40 p-4 rounded-lg flex items-center gap-4">
                  <div className="text-xs text-gray-400">Your answer</div>
                  <div className="flex-1 bg-white/6 p-3 rounded-lg text-xl font-mono">{input||'—'}</div>
                  <div className="flex gap-2">
                    <button onClick={handleSubmit} className="px-4 py-2 rounded-lg bg-emerald-600">Submit</button>
                    <button onClick={exitGame} className="px-4 py-2 rounded-lg bg-red-600">Exit</button>
                  </div>
                </div>

                <div className="mt-4 grid grid-cols-3 gap-2">
                  {[1,2,3,4,5,6,7,8,9,'C',0,'⌫'].map((k,i)=> (
                    <button key={i} onClick={()=>{ if(k==='C') clearInput(); else if(k==='⌫') backspace(); else appendDigit(k) }} className="py-3 rounded-xl bg-slate-700/40">{k}</button>
                  ))}
                </div>
              </div>
            </section>

            <aside className="bg-slate-800/20 p-4 rounded-2xl">
              <div className="grid gap-3">
                <div>
                  <div className="text-xs text-gray-300">Best score</div>
                  <div className="text-lg font-semibold">{history.length? Math.max(...history.map(h=>h.score)) : 0}</div>
                </div>
                <div>
                  <div className="text-xs text-gray-300">Games played</div>
                  <div className="text-lg font-semibold">{history.length}</div>
                </div>
                <div>
                  <div className="text-xs text-gray-300">Weak area</div>
                  <div className="text-lg font-semibold">{weakest()}</div>
                </div>
              </div>
            </aside>
          </main>
        )}

        {finished && (
          <div className="bg-slate-800/40 p-6 rounded-2xl">
            <h2 className="text-xl font-semibold mb-4">Session Review</h2>
            <div className="mb-4">
              <div className="text-sm">Attempts: {attempts}, Score: {score}, Time: {currentMode==='timed60'?60:Math.round((Date.now()-startTime)/1000)}s</div>
              <div className="mt-2 max-h-80 overflow-auto text-sm space-y-2">
                {sessionQuestions.map((q,idx)=>(
                  <div key={idx} className="p-2 rounded-lg bg-slate-900/50">
                    <div className="flex justify-between">
                      <span>{q.text}</span>
                      <span className={q.correct? 'text-emerald-400':'text-rose-400'}>{q.correct? 'OK':'WRONG'}</span>
                    </div>
                    <div className="text-xs text-gray-300">Your: {q.input}</div>
                    <div className="text-xs">{solutionFor(q)}</div>
                  </div>
                ))}
              </div>
            </div>
            <div className="mt-4 flex justify-center gap-4">
              <button onClick={()=>startMode(currentMode)} className="px-6 py-2 rounded-xl bg-indigo-600">Play Again</button>
              <button onClick={exitGame} className="px-6 py-2 rounded-xl bg-gray-600">Home</button>
            </div>
          </div>
        )}

        <footer className="mt-6 text-xs text-gray-400 text-center">No ads • For students • Open-source friendly — place <code>index.html</code> at repo root or in <code>docs/</code> and enable GitHub Pages</footer>
      </div>
    )
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App />)
  </script>
</body>
</html>
